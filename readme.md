# xxczaki/discord-bot

![Lint](https://github.com/xxczaki/discord-bot/actions/workflows/lint.yml/badge.svg) [![Test](https://github.com/xxczaki/discord-bot/actions/workflows/test.yml/badge.svg)](https://github.com/xxczaki/discord-bot/actions/workflows/test.yml) [![Deploy](https://github.com/xxczaki/discord-bot/actions/workflows/deploy.yml/badge.svg)](https://github.com/xxczaki/discord-bot/actions/workflows/deploy.yml) [![Coverage Status](https://coveralls.io/repos/github/xxczaki/discord-bot/badge.svg?branch=main)](https://coveralls.io/github/xxczaki/discord-bot?branch=main) [![Artifact Hub](https://img.shields.io/endpoint?url=https://artifacthub.io/badge/repository/xxczaki)](https://artifacthub.io/packages/helm/xxczaki/discord-bot)

> ðŸŽµ Music bot for my private Discord server, powered by discord-player

![Preview of the `/play` command](https://github.com/user-attachments/assets/2279d0ff-a248-489c-b880-1d6bcf0c2f7f)

## Features

- Music playback from YouTube
	- On-disk Opus file cache for subsequent streams
- Cached search powered by Spotify or YouTube
- Relies heavily on slash commands and message components
- Playlists stored in a dedicated channel
- Spotify-like volume normalization
- Recovery mechanism to continue listening after an error
- Redis-backed playback statistics
- AI-powered queue control with `/prompt` command (optional)
	- Natural language queue manipulation (e.g., "remove all bob dylan songs", "move all tracks from genesis to the front and play them now")
	- Powered by OpenAI's gpt-4o-mini with AI SDK v5
	- Global rate limit of 100 calls per day
	- Requires `OPENAI_API_KEY` environment variable
- Maintenance mode that uses Kubernetes' API
- Lockdown mode for restricting command access temporarily
- Tic-tac-toe
- Friendly `/help` command
- Integration with Sentry
- Extensive logging powered by Pino
- Easy deployment with a [Helm chart](https://github.com/xxczaki/charts/tree/main/charts/discord-bot)

## Deployment

You have two options:

1. Use the [Helm chart](https://github.com/xxczaki/charts/tree/main/charts/discord-bot) (recommended)
2. Use the Docker image from either [Docker Hub](https://hub.docker.com/r/xxczaki/discord-bot) or [GitHub Container Registry](https://github.com/xxczaki/discord-bot/pkgs/container/discord-bot)

> [!NOTE]
> Required environment variables:
> - `REDIS_URL` - Redis instance connection string
>
> Optional environment variables:
> - `OPENAI_API_KEY` - OpenAI API key for the `/prompt` command (can be obtained from [OpenAI Platform](https://platform.openai.com/api-keys))

[![Deploy on Railway](https://railway.com/button.svg)](https://railway.com/deploy/tgifQE?referralCode=4Ee-1n)

## Development

First, install the Node.js version defined in the `.nvmrc` file and pnpm (ideally through Corepack).

```sh
# Install dependencies
$ pnpm install

# Start the bot in development mode
$ pnpm start

# Build the bot for production
$ pnpm build

# Lint, type check, and test
$ pnpm lint && pnpm tsc && pnpm test

# Test with coverage report
$ pnpm test:coverage
```

If you are using VS Code or a compatible editor, you can start the bot with a debugger attached using the `debug` task.

## Limitations

The bot was designed to be used on a single Discord server, on a small scale â€“ typically on one voice channel at once. Therefore, it doesn't scale well horizontally.

## Versioning policy

- the Docker images are tagged with commit SHAs
- the Helm chart uses a `MAJOR.MINOR.PATCH` format where:
	- the `PATCH` increases with each Docker image update
	- the `MINOR` increases when other changes are made to the chart itself, e.g., when a Redis version is updated

## Stability

The project should be consider to be in a **pre-alpha** stage:
- frequent nightly builds are released
- breaking changes occur often
- existing features may evolve or be removed without notice

No timeline for an alpha/beta release is planned.

## Legal

Please read the [Legal Disclaimer](./legal.md) before using this software.

## AI disclosure

This project contains code generated by Large Language Models (LLMs), under human supervision and proofreading.

### License

MIT
